<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</title>
   {% load static humanize %}
   <link rel="stylesheet" href="{% static 'styles.css' %}">
   <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
   <style>
      input[type="date"],
      input[type="text"],
      select {
         width: 100%;
         padding: 8px;
         box-sizing: border-box;
         border: 1px solid #ccc;
         border-radius: 4px;
         font-size: 10px;
         background-color: #fff;
      }
      button {
         padding: 10px 20px;
         margin-top: 10px;
         cursor: pointer;
      }
      hr {
         margin: 20px 0;
      }
      .results-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 10px;
      }
      .table-container {
         overflow-x: auto;
         max-width: 100%;
      }
      table {
         width: 50%;
         border-collapse: collapse;
         background: white;
         direction: rtl;
         margin: 20px auto;
         direction: rtl;
      }
      table th,
      table td {
         border: 1px solid #dee2e6;
         padding: 6px;
         font-size: 12px;
         text-align: center;
      }
      table th {
         background-color: #3190d0;
         color: white;
         white-space: nowrap;
      }
      .date-column {
         white-space: nowrap;
      }
      .hide-in-pdf {
         display: table-cell;
      }
      @media print {
         .hide-in-pdf {
            display: none;
         }
      }
      .messages { color: red; text-align: center; }
      .cargo-selection {
         align-items: center;
         gap: 10px;
      }
      .selected-cargos {
         margin-top: 10px;
      }
      .selected-cargos ul {
         list-style: none;
         padding: 0;
      }
      .selected-cargos li {
         background: #e9ecef;
         padding: 5px 10px;
         margin: 5px 0;
         display: flex;
         justify-content: space-between;
         align-items: center;
      }
      .remove-cargo,
      .remove-country {
         cursor: pointer;
         color: red;
         font-weight: bold;
         margin-right: 5px;
      }
      .shipment-item {
         padding: 5px 0;
         border-bottom: 1px solid #dee2e6;
      }
      .shipment-item:last-child {
         border-bottom: none;
      }
      .suggestions {
         background: #fff;
         border: 1px solid #ccc;
         border-radius: 8px;
         max-height: 200px;
         overflow-y: auto;
         width: 100%;
         z-index: 1000;
         box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
         font-size: 14px;
         margin-top: 5px;
      }
      .suggestions div {
         padding: 10px 12px;
         cursor: pointer;
         border-bottom: 1px solid #f0f0f0;
         transition: background-color 0.2s ease;
      }
      .suggestions div:last-child {
         border-bottom: none;
      }
      .suggestions div:hover {
         background: #e6f0fa;
         color: #005566;
      }
      .suggestions::-webkit-scrollbar {
         width: 8px;
      }
      .suggestions::-webkit-scrollbar-track {
         background: #f1f1f1;
         border-radius: 8px;
      }
      .suggestions::-webkit-scrollbar-thumb {
         background: #888;
         border-radius: 8px;
      }
      .suggestions::-webkit-scrollbar-thumb:hover {
         background: #555;
      }
      .input-wrapper {
         position: relative;
         display: flex;
         align-items: center;
      }
   </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-right" dir="ltr">
      <label id="headerRight2">Ù†Ø¸Ø§Ù… Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…ØµØ¯Ø± ÙˆØ§Ù„Ù…Ù†Ø´Ø£ | </label>
      <label id="headerRight"> Ø§Ù„ØºØ±ÙØ© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø¨Ø§Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ© </label>
      <img src="{% static 'ACOC_Logo_Final[1].png' %}" alt="Company Logo" class="logo">
    </div>
    <div class="navbar-left" dir="rtl">
      <label id="headerLeft2"> Origin Certificate System | </label>
      <label id="headerLeft"> Alexandria Chamber of Commerce </label>
    </div>
    <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
        <div class="user-dropdown">
        <button class="user-btn" onclick="toggleDropdown()">
            <i class="user-icon">ğŸ‘¤</i>
        </button>
        <div class="dropdown-content" id="userDropdown">
            <div class="user-info">
                <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ request.user.get_full_name|default:request.user.username }}</p>
                {% if request.user.userprofile.branch %}
                    <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> {{ request.user.userprofile.branch.name }}</p>
                {% endif %}
                <p><strong>Ø§Ù„Ø¯ÙˆØ±:</strong> 
                    {% if request.user.is_superuser %}
                        Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¹Ø§Ù…
                    {% elif request.user.userprofile.is_branch_admin %}
                        Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹
                    {% else %}
                        Ù…Ø³ØªØ®Ø¯Ù…
                    {% endif %}
                </p>
            </div>
            <form action="{% url 'logout' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="logout-btn" style="background: none; border: none; cursor: pointer;">
                    <i class="logout-icon">ğŸšª</i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </form>
        </div>
    </div>
  </nav>
   <div class="sidebar" id="sidebar">
      <a href="javascript:void(0)" onclick="toggleSidebar()">âœ–</a>
      <a href="{% url 'index' %}">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="{% url 'filter' %}">ØªØµÙÙŠØ©</a>
      <a href="{% url 'cargo' %}">Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹</a>
      <a href="{% url 'country' %}">Ø§Ù„Ø¨Ù„Ø¯</a>
      <a href="{% url 'report' %}">ØªÙ‚Ø±ÙŠØ±</a>
   </div>

   <div class="content-wrapper">
      <div class="container">
         <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</h1>
         <form method="get" action="{% url 'report' %}" id="reportForm">
            <div class="form-group">
               <label for="branchName">Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹:</label>
               <select id="branchName" name="branch_name">
                  <option value="" {% if not branch_name %}selected{% endif %}>Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>
                  <option value="Ù…Ø­Ø·Ù‡ Ø§Ù„Ø±Ù…Ù„" {% if branch_name == "Ù…Ø­Ø·Ù‡ Ø§Ù„Ø±Ù…Ù„" %}selected{% endif %}>Ù…Ø­Ø·Ù‡ Ø§Ù„Ø±Ù…Ù„</option>
                  <option value="Ø§Ù„Ø³Ù„Ø·Ø§Ù† Ø­Ø³ÙŠÙ†" {% if branch_name == "Ø§Ù„Ø³Ù„Ø·Ø§Ù† Ø­Ø³ÙŠÙ†" %}selected{% endif %}>Ø§Ù„Ø³Ù„Ø·Ø§Ù† Ø­Ø³ÙŠÙ†</option>
                  <option value="Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ" {% if branch_name == "Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ" %}selected{% endif %}>Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ</option>
               </select>
            </div>
            <div class="form-group">
               <label for="process_date_from">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ù†:</label>
               <input type="date" id="process_date_from" name="process_date_from" value="{{ process_date_from }}">
            </div>
            <div class="form-group">
               <label for="process_date_to">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ù„Ù‰:</label>
               <input type="date" id="process_date_to" name="process_date_to" value="{{ process_date_to }}">
            </div>
            <div class="form-group">
               <label for="export_country">Ø¨Ù„Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ±:</label>
               <div class="input-wrapper">
                  <input type="text" id="countrySearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¨Ù„Ø¯..." 
                         onkeyup="searchCountries(this.value)" onfocus="searchCountries('')" 
                         value="{{ selected_country }}" autocomplete="off">
                  <span class="remove-country" onclick="clearCountry()" style="display: none;">Ã—</span>
               </div>
               <input type="hidden" name="export_country" id="export_country_hidden" value="{{ selected_country }}">
               <div id="countrySuggestions" class="suggestions" style="display: none;"></div>
            </div>
            <div class="form-group">
               <label for="cargo">Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©:</label>
               <div class="cargo-selection">
                  <div class="input-wrapper">
                     <input type="text" id="cargoSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¨Ø¶Ø§Ø¹Ø©..." 
                            onkeyup="debouncedSearchCargos(this.value)" onfocus="searchCargos('')" autocomplete="off">
                  </div>
                  <div id="cargoSuggestions" class="suggestions" style="display: none;"></div>
                  <button type="button" onclick="addCargoFromSearch()">Ø¥Ø¶Ø§ÙØ©</button>
               </div>
               <div class="selected-cargos">
                  <ul id="selectedCargosList">
                     {% for cargo in selected_cargos %}
                     <li data-id="{{ cargo.id }}">{{ cargo.ExportedGoods }} <span class="remove-cargo" onclick="removeCargo(this)">Ã—</span></li>
                     {% endfor %}
                  </ul>
                  <input type="hidden" name="cargo_ids" id="cargoIdsInput" value="{{ selected_cargo_ids|join:',' }}">
               </div>
            </div>
            <button type="submit">Ù…ÙˆØ§ÙÙ‚</button>
         </form>

         <hr>
         {% if messages %}
            <div class="messages">
               {% for message in messages %}
                  <p>{{ message }}</p>
               {% endfor %}
            </div>
         {% endif %}
         <div class="results-header">
            <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h2>
            <p id="certificateCount" style="margin: 0; font-weight: bold;"></p>
         </div>
         <div class="table-container">
            <table id="certificatesTable">
               <thead>
                  <tr>
                     <th class="hide-in-pdf">Ø§Ù„Ù…Ø¹Ø±Ù</th>
                     <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨</th>
                     <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„</th>
                     <th>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th>
                     <th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th>
                     <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø±ÙƒØ©</th>
                     <th class="hide-in-pdf">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ù‡</th>
                     <th class="hide-in-pdf">Ù†ÙˆØ¹ Ø§Ù„Ø´Ø±ÙƒØ©</th>
                     <th>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</th>
                     <th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒÙ‡ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ù‡</th>
                     <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø±ÙƒÙ‡ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ù‡</th>
                     <th>ØªÙ„ÙŠÙÙˆÙ† Ø§Ù„Ø´Ø±ÙƒÙ‡ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ù‡</th>
                     <th>Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹</th>
                     <th>Ø¨Ù„Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ±</th>
                     <th>Ø¨Ù„Ø¯ Ø§Ù„Ù…Ù†Ø´Ø£</th>
                     <th class="date-column">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                     <th class="hide-in-pdf">Ø±Ù‚Ù… Ø§Ù„Ø§ÙŠØµØ§Ù„</th>
                     <th class="hide-in-pdf date-column">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙŠØµØ§Ù„</th>
                     <th class="hide-in-pdf">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</th>
                     <th>Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø§Ù„ÙƒÙ…ÙŠØ©)</th>
                     <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                  </tr>
               </thead>
               <tbody>
                  {% for cert in certificates %}
                  <tr class="data-row">
                     <td class="hide-in-pdf">{{ cert.id }}</td>
                     <td>{{ cert.Office.OfficeName|default:'' }}</td>
                     <td>{{ cert.RegistrationNumber|default:'' }}</td>
                     <td>{{ cert.CertificateNumber|default:'' }}</td>
                     <td>{{ cert.Company.CompanyName|default:'' }}</td>
                     <td>{{ cert.Company.CompanyAddress|default:'' }}</td>
                     <td class="hide-in-pdf">{{ cert.Company.CompanyStatus|default:'' }}</td>
                     <td class="hide-in-pdf">{{ cert.Company.CompanyType|default:'' }}</td>
                     <td>{{ cert.BranchName|default:'' }}</td>
                     <td>{{ cert.Company.importCompanyName|default:'' }}</td>
                     <td>{{ cert.Company.importCompanyAddress|default:'' }}</td>
                     <td>{{ cert.Company.importCompanyPhone|default:'' }}</td>
                     <td>
                        {% for shipment in cert.shipments.all %}
                           <div class="shipment-item">
                              {{ shipment.cargo.ExportedGoods }}{% if shipment.quantity and cert.quantity_unit %}, {{ shipment.quantity }} {{ cert.quantity_unit }}{% endif %}{% if shipment.cost_amount and cert.default_currency %}, {{ shipment.cost_amount|intcomma }} {{ cert.default_currency }}{% endif %}
                           </div>
                        {% empty %}
                           ØºÙŠØ± Ù…ØªÙˆÙØ±
                        {% endfor %}
                     </td>
                     <td>{{ cert.ExportCountry.CountryName|default:'' }}</td>
                     <td>{{ cert.OriginCountry.CountryName|default:'' }}</td>
                     <td class="date-column">{{ cert.IssueDate|default:'' }}</td>
                     <td class="hide-in-pdf">{{ cert.ReceiptNumber|default:'' }}</td>
                     <td class="hide-in-pdf date-column">{{ cert.ReceiptDate|default:'' }}</td>
                     <td class="hide-in-pdf">{{ cert.PaymentAmount|floatformat:2|intcomma|default:'' }}</td>
                     <td>{{ cert.total_quantity|floatformat:2|intcomma|default:'' }} {{ cert.quantity_unit|default:'' }}</td>
                     <td>{{ cert.total_cost.amount|floatformat:2|intcomma|default:'' }} {{ cert.default_currency|default:'' }}</td>
                  </tr>
                  {% empty %}
                  <tr class="no-data">
                     <td colspan="21">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td>
                  </tr>
                  {% endfor %}
               </tbody>
            </table>
         </div>
         <!-- Totals table rendered outside the main table -->
         <div id="totalsContainer">
            <table class="totals-table">
               <tr>
                  {% for total in currency_totals %}
                  <th>{{ total.cost_currency }}</th>
                  {% endfor %}
               </tr>
               <tr>
                  {% for total in currency_totals %}
                  <td>{{ total.total_cost|floatformat:2|intcomma }}</td>
                  {% endfor %}
               </tr>
            </table>
         </div>
         <div class="download-buttons">
            <form id="exportForm" method="get" action="{% url 'report_download' 'excel' %}" style="display: inline;">
               <label>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„ØªØµØ¯ÙŠØ±:</label><br>
               <input type="checkbox" name="columns" value="id" checked> Ø§Ù„Ù…Ø¹Ø±Ù
               <input type="checkbox" name="columns" value="cargo" checked> Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹
               <input type="checkbox" name="columns" value="cost" checked> Ø§Ù„ØªÙƒÙ„ÙØ©
               <input type="checkbox" name="columns" value="export_country" checked> Ø¨Ù„Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ±
               <input type="checkbox" name="columns" value="branch" checked> Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹
               <input type="checkbox" name="columns" value="issue_date" checked> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
               <input type="hidden" name="process_date_from" value="{{ process_date_from }}">
               <input type="hidden" name="process_date_to" value="{{ process_date_to }}">
               <input type="hidden" name="export_country" value="{{ selected_country }}">
               <input type="hidden" name="branch_name" value="{{ branch_name }}">
               <input type="hidden" name="cargo_ids" value="{{ selected_cargo_ids|join:',' }}">
               <button type="submit">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ù‡ Excel</button>
            </form>
            <button>
               <a href="{% url 'report_download' 'excel' %}?process_date_from={{ process_date_from }}&process_date_to={{ process_date_to }}&export_country={{ selected_country }}{% for cargo_id in selected_cargo_ids %}&cargo_ids={{ cargo_id }}{% endfor %}">
               Excel
               </a>
            </button>
            <button onclick="printTableAsPDF()">PDF</button>
            <button>
               <a href="{% url 'empty_report_download' 'excel' %}">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</a>
            </button>
         </div>
      </div>
   </div>

   <div class="footer">
      <p>This website and system have been developed by the Alexandria Chamber of Commerce IT Department. 
         For any inquiries, please contact the IT Department via email at it@alexandria-chamber.com.
         Unauthorized access, misuse, or any illegal activities related to this system are strictly prohibited and may result in legal action. 
         All activities on this platform are monitored and logged for security purposes.</p>
      <img src="{% static 'ACOC.png' %}" alt="Footer Image" class="footer-img">
   </div>

   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
   <script>
      $(document).ready(function() {
         $('#certificatesTable').DataTable({
            "paging": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "language": {
               "search": "Ø¨Ø­Ø«:",
               "lengthMenu": "Ø¹Ø±Ø¶ _MENU_ Ø³Ø¬Ù„Ø§Øª Ù„ÙƒÙ„ ØµÙØ­Ø©",
               "zeroRecords": "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©",
               "info": "Ø¹Ø±Ø¶ _START_ Ø¥Ù„Ù‰ _END_ Ù…Ù† _TOTAL_ Ø³Ø¬Ù„",
               "infoEmpty": "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ§Ø­Ø©",
               "infoFiltered": "(ØªÙ…Øª ØªØµÙÙŠØªÙ‡Ø§ Ù…Ù† _MAX_ Ø³Ø¬Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ)",
               "paginate": {
                  "first": "Ø§Ù„Ø£ÙˆÙ„",
                  "last": "Ø§Ù„Ø£Ø®ÙŠØ±",
                  "next": "Ø§Ù„ØªØ§Ù„ÙŠ",
                  "previous": "Ø§Ù„Ø³Ø§Ø¨Ù‚"
               }
            }
         });
         const countrySearch = document.getElementById('countrySearch');
         if (countrySearch.value) {
            document.querySelector('.remove-country').style.display = 'inline';
         }
      });

      function updateCertificateCount() {
         const rows = document.querySelectorAll("#certificatesTable tbody tr.data-row");
         const count = rows.length;
         document.getElementById("certificateCount").textContent = "Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª: " + count;
      }
      document.addEventListener("DOMContentLoaded", updateCertificateCount);

      window.onload = function() {
         window.history.replaceState({}, document.title, window.location.pathname);
      };

      function toggleSidebar() {
         var sidebar = document.getElementById("sidebar");
         sidebar.classList.toggle("active");
      }

      // Debounce function to reduce search requests
      function debounce(func, wait) {
         let timeout;
         return function executedFunction(...args) {
            const later = () => {
               clearTimeout(timeout);
               func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
         };
      }

      document.addEventListener('click', function(e) {
         const sidebar = document.getElementById('sidebar');
         const menuBtn = document.querySelector('.menu-btn');
         const countrySuggestions = document.getElementById('countrySuggestions');
         const cargoSuggestions = document.getElementById('cargoSuggestions');
         const countrySearch = document.getElementById('countrySearch');
         const cargoSearch = document.getElementById('cargoSearch');

         if (sidebar.classList.contains('active') && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
            sidebar.classList.remove('active');
         }

         if (!countrySuggestions.contains(e.target) && e.target !== countrySearch && document.activeElement !== countrySearch) {
            countrySuggestions.style.display = 'none';
         }

         if (!cargoSuggestions.contains(e.target) && e.target !== cargoSearch && document.activeElement !== cargoSearch) {
            cargoSuggestions.style.display = 'none';
         }
      });

      let selectedCountry = '{{ selected_country|default:'' }}';
      function searchCountries(query) {
         $.ajax({
            url: '{% url "search_countries" %}',
            data: { 'q': query },
            success: function(data) {
               const suggestions = document.getElementById('countrySuggestions');
               suggestions.innerHTML = '';
               if (data.length > 0) {
                  data.forEach(country => {
                     const div = document.createElement('div');
                     div.textContent = country.CountryName;
                     div.onclick = function() {
                        selectedCountry = country.CountryName;
                        document.getElementById('countrySearch').value = country.CountryName;
                        document.getElementById('export_country_hidden').value = country.CountryName;
                        suggestions.style.display = 'none';
                        document.querySelector('.remove-country').style.display = 'inline';
                     };
                     suggestions.appendChild(div);
                  });
                  suggestions.style.display = 'block';
               } else {
                  suggestions.innerHTML = '<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                  suggestions.style.display = 'block';
               }
            }
         });
      }

      function clearCountry() {
         document.getElementById('countrySearch').value = '';
         document.getElementById('export_country_hidden').value = '';
         document.querySelector('.remove-country').style.display = 'none';
         selectedCountry = null;
      }

      let selectedCargo = null;
      function searchCargos(query) {
         $.ajax({
            url: '{% url "search_cargos" %}',
            data: { 'q': query },
            success: function(data) {
               const suggestions = document.getElementById('cargoSuggestions');
               suggestions.innerHTML = '';
               if (data.length > 0) {
                  data.forEach(cargo => {
                     const div = document.createElement('div');
                     div.textContent = cargo.ExportedGoods;
                     div.setAttribute('data-id', cargo.id);
                     div.onclick = function() {
                        selectedCargo = { id: cargo.id, name: cargo.ExportedGoods };
                        document.getElementById('cargoSearch').value = cargo.ExportedGoods;
                        suggestions.style.display = 'none';
                     };
                     suggestions.appendChild(div);
                  });
                  suggestions.style.display = 'block';
               } else {
                  suggestions.innerHTML = '<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                  suggestions.style.display = 'block';
               }
            }
         });
      }

      const debouncedSearchCargos = debounce(searchCargos, 300);

      function addCargoFromSearch() {
         if (!selectedCargo) return;
         const selectedList = document.getElementById('selectedCargosList');
         const existingIds = Array.from(selectedList.getElementsByTagName('li')).map(li => li.getAttribute('data-id'));
         if (!existingIds.includes(selectedCargo.id.toString())) {
            const li = document.createElement('li');
            li.setAttribute('data-id', selectedCargo.id);
            li.innerHTML = `${selectedCargo.name} <span class="remove-cargo" onclick="removeCargo(this)">Ã—</span>`;
            selectedList.appendChild(li);
            updateCargoIdsInput();
         }
         document.getElementById('cargoSearch').value = '';
         selectedCargo = null;
      }

      function removeCargo(element) {
         element.parentElement.remove();
         updateCargoIdsInput();
      }

      function updateCargoIdsInput() {
    const selectedList = document.getElementById('selectedCargosList');
    const cargoIds = Array.from(selectedList.getElementsByTagName('li'))
        .map(li => li.getAttribute('data-id'))
        .filter(id => id);  // Remove empty/null IDs
    document.getElementById('cargoIdsInput').value = cargoIds.join(',');
    document.getElementById('exportCargoIds').value = cargoIds.join(','); // Sync with export form
}

      function printTableAsPDF() {
         let printWindow = window.open('', '_blank');
         if (!printWindow) {
             alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©');
             return;
         }
         let table = document.getElementById('certificatesTable');
         let countElement = document.getElementById('certificateCount');
         let certCountText = countElement ? countElement.textContent : '';
         if (!table) {
             alert('Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
             printWindow.close();
             return;
         }

         // Clone the main table
         let clonedTable = table.cloneNode(true);
         // Remove unnecessary columns (indexes: 0, 6, 7, 16, 17, 18)
         const columnsToRemove = [0, 6, 7, 16, 17, 18];
         let thead = clonedTable.querySelector('thead tr');
         if (thead) {
            Array.from(thead.children).forEach((th, index) => {
               if (columnsToRemove.includes(index)) {
                  th.remove();
               }
            });
         }
         let tbodyRows = clonedTable.querySelectorAll('tbody tr');
         if (tbodyRows.length) {
            tbodyRows.forEach(row => {
               Array.from(row.children).forEach((td, index) => {
                  if (columnsToRemove.includes(index)) {
                     td.remove();
                  }
               });
            });
         }
         // Get totals table from the separate container
         let totalsContainer = document.getElementById('totalsContainer');
         let totalsHTML = totalsContainer ? totalsContainer.innerHTML : '';
         let htmlContent = `
         <html lang="ar" dir="rtl">
            <head>
               <meta charset="UTF-8">
               <meta name="viewport" content="width=device-width, initial-scale=1.0">
               <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</title>
               <style>
                  @page { size: A4 landscape; margin: 20mm; }
                  body { font-family: Arial, sans-serif; margin: 0; padding: 10mm; background-color: #f4f6f9; text-align: center; }
                  .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
                  .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; }
                  .header-item { display: flex; align-items: center; gap: 5px; font-size: 18px; font-weight: bold; color: #1866ae; }
                  .header img { height: 45px; }
                  .header-title { font-size: 24px; font-weight: bold; color: #1866ae; text-align: center; margin-top: 10px; }
                  table { width: 50%; margin: 20px auto; border-collapse: collapse; background: white; direction: rtl; }
                  table th, table td { border: 1px solid #dee2e6; padding: 6px; font-size: 10px; text-align: center; }
                  table th { background-color: #3190d0; color: white; white-space: nowrap; }
                  .totals-table { width: 50%; margin: 10px auto; border-collapse: collapse; }
                  .totals-table th, .totals-table td { border: 1px solid #dee2e6; padding: 8px 12px; font-size: 14px; text-align: center; }
                  .totals-table th { background-color: #3190d0; color: white; }
               </style>
            </head>
            <body>
               <div class="header">
                  <div class="header-item">
                     <img src="/static/ACOC.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ØºØ±ÙØ© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©">
                     <span>Ø§Ù„ØºØ±ÙØ© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø¨Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</span>
                  </div>
                  <div class="header-item">
                     <span>Alexandria Chamber of Commerce</span>
                     <img src="/static/ACOC_Logo_Final[1].png" alt="Alexandria Chamber of Commerce Logo">
                  </div>
               </div>
               <div class="header-title">Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…ØµØ¯Ø±</div>
               <div class="container">
                  <div class="count">${certCountText}</div>
                  ${clonedTable.outerHTML}
                  <div id="printTotals">${totalsHTML}</div>
               </div>
               <script>
                  window.onload = function() {
                     window.print();
                     window.close();
                  }
               <\/script>
            </body>
         </html>
         `;
         printWindow.document.open();
         printWindow.document.write(htmlContent);
         printWindow.document.close();
      }
      function toggleDropdown() {
    document.getElementById("userDropdown").classList.toggle("show-dropdown");
}

// Close the dropdown if clicked outside
window.onclick = function(event) {
    if (!event.target.matches('.user-btn') && !event.target.closest('.user-dropdown')) {
        const dropdowns = document.getElementsByClassName("dropdown-content");
        for (let i = 0; i < dropdowns.length; i++) {
            const openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show-dropdown')) {
                openDropdown.classList.remove('show-dropdown');
            }
        }
    }
}
   </script>
</body>
</html>
