<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <style>
      body {
          font-family: 'Arial', sans-serif;
      }
  </style>
   <title>تقرير الشهادات</title>
   {% load static %}
   <link rel="stylesheet" href="{% static 'styles.css' %}">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
   <nav class="navbar">
      <div class="navbar-right">
         <img src="{% static 'Alexandra_CC_Logo.jpg' %}" alt="Company Logo" class="logo">
         <label id="header">الغرفة التجارية</label>
      </div>
      <button class="menu-btn" onclick="toggleSidebar()">☰</button>
   </nav>

   <div class="sidebar" id="sidebar">
      <a href="javascript:void(0)" onclick="toggleSidebar()">✖️</a>
      <a href="{% url 'index' %}">الصفحة الرئيسية</a>
      <a href="{% url 'filter' %}">تصفية</a>
      <a href="{% url 'cargo' %}">البضائع</a>
      <a href="{% url 'country' %}">البلد</a>
      <a href="{% url 'report' %}">تقرير</a>
   </div>

   <div class="container">
      <h1>تقرير الشهادات</h1>
      <form method="get" action="{% url 'report' %}">
         <div class="form-group">
            <label for="process_date_from">تاريخ العملية من:</label>
            <input type="date" id="process_date_from" name="process_date_from" value="{{ process_date_from }}">
         </div>
         <div class="form-group">
            <label for="process_date_to">تاريخ العملية إلى:</label>
            <input type="date" id="process_date_to" name="process_date_to" value="{{ process_date_to }}">
         </div>
         <div class="form-group">
            <label for="cargo">البضاعة:</label>
            <select name="cargo" id="cargo">
               <option value="">اختر البضاعة</option>
               {% for item in cargos %}
               <option value="{{ item.id }}" {% if item.id|stringformat:"s" == selected_cargo %}selected{% endif %}>
                     {{ item.ExportedGoods }}
                  </option>
               {% endfor %}
            </select>
         </div>
         <div class="form-group">
            <label for="export_country">بلد التصدير:</label>
            <select name="export_country" id="export_country">
               <option value="">اختر بلد التصدير</option>
               {% for country in countries %}
                  <option value="{{ country.CountryName }}" {% if country.CountryName == selected_country %}selected{% endif %}>
                     {{ country.CountryName }}
                  </option>
               {% endfor %}
            </select>
         </div>
         <button type="submit">موافق</button>
      </form>

      <hr>
      <h2>نتائج التقرير</h2>
      <table id = 'certificatesTable'>
         <thead>
            <tr>
               <th>المعرف</th>
               <th>اسم المكتب</th>
               <th>اسم الفرع</th>
               <th>رقم السجل</th>
               <th>رقم الشهادة</th>
               <th>اسم الشركة</th>
               <th>عنوان الشركة</th>
               <th>حالة الشركة</th>
               <th>نوع الشركة</th>
               <th>البضائع</th>
               <th>بلد المنشأ</th>
               <th>بلد التصدير</th>
               <th>تاريخ العملية</th>
               <th>رقم الايصال</th>
               <th>تاريخ الايصال</th>
               <th>القيمة المدفوعة</th>
               <th>القيمة (الكمية)</th>
               <th>التكلفة</th>
            </tr>
         </thead>
         <tbody>
            {% for cert in certificates %}
            <tr>
               <td>{{ cert.id }}</td>
               <td>{{ cert.Office.OfficeName }}</td>
               <td>{{ cert.Office.BranchName }}</td>
               <td>{{ cert.RegistrationNumber }}</td>
               <td>{{ cert.CertificateNumber }}</td>
               <td>{{ cert.Company.CompanyName }}</td>
               <td>{{ cert.Company.CompanyAddress }}</td>
               <td>{{ cert.Company.CompanyStatus }}</td>
               <td>{{ cert.Company.CompanyType }}</td>
               <td>{{ cert.ExportedGoods.ExportedGoods }}</td>
               <td>{{ cert.OriginCountry.CountryName }}</td>
               <td>{{ cert.ExportCountry.CountryName }}</td>
               <td>{{ cert.IssueDate }}</td>
               <td>{{ cert.ReceiptNumber }}</td>
               <td>{{ cert.ReceiptDate }}</td>
               <td>{{ cert.PaymentAmount }}</td>
               <td>{{ cert.quantity }} {{ cert.quantity_unit }}</td>
               <td>{{ cert.cost }}</td>
            </tr>
            {% empty %}
            <tr>
               <td colspan="18">لا توجد بيانات</td>
            </tr>
            {% endfor %}
         </tbody>
      </table>
      <div class="download-buttons">
         <button>
         <a href="{% url 'report_download' 'excel' %}?process_date_from={{ process_date_from }}&process_date_to={{ process_date_to }}&cargo={{ selected_cargo }}&export_country={{ selected_country }}" class="download-btn">
            تنزيل Excel
         </a>
      </button>
      <button onclick="printTableAsPDF()">طباعة الشهادات PDF</button>
 
     </div>
   <script>
      window.onload = function() {
         if (window.location.search) {
            let params = new URLSearchParams(window.location.search);
            let keepParams = ['process_date_from', 'process_date_to', 'cargo', 'export_country'];

            let newParams = new URLSearchParams();
            keepParams.forEach(param => {
                  if (params.has(param)) {
                     newParams.set(param, params.get(param));
                  }
            });

            window.history.replaceState({}, document.title, window.location.pathname + '?' + newParams.toString());
         }
      };
      function toggleSidebar() {
    var sidebar = document.getElementById("sidebar");
    sidebar.classList.toggle("active");
}

// Close the sidebar when clicking anywhere outside the sidebar and menu button
document.addEventListener('click', function (e) {
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.querySelector('.menu-btn');

  // If sidebar is active and the click target is not inside the sidebar or the menu button, remove the active class.
  if (sidebar.classList.contains('active') &&
      !sidebar.contains(e.target) &&
      !menuBtn.contains(e.target)) {
    sidebar.classList.remove('active');
  }
});
function printTableAsPDF() {
    let printWindow = window.open('', '_blank');
    let table = document.getElementById('certificatesTable');
    if (!table) {
        alert('الجدول غير موجود!');
        return;
    }
    
    let htmlContent = `
        <html>
        <head>
            <title>طباعة الشهادات</title>
            <style>
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid black; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
            </style>
        </head>
        <body>
            ${table.outerHTML}
            <script>
                window.onload = function() {
                    window.print();
                    window.close();
                }
            <\/script>
        </body>
        </html>
    `;
    
    printWindow.document.open();
    printWindow.document.write(htmlContent);
    printWindow.document.close();
}
    </script>    
</body>
</html>